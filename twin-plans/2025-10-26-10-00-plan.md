# Twin Development Plan
Generated: 2025-10-26
Task: Implementar a Phase 2, criar o .env.local para documentar todas as variáveis necessárias, e substituir todas as referências "asimov" por "ChatBot" (nome do projeto)
Quality Level: pragmatic

## Análise Técnica

### Estado Atual
- **Estrutura existente**: Apenas workflow n8n (IA.json) + documentação markdown
- **Não existe**: Nenhum arquivo Next.js, package.json, estrutura de diretórios ou configurações
- **Status**: 100% Phase 1 (backend n8n puro)

### O Que Precisa Ser Construído

**Phase 2 - Dashboard Next.js Read-Only:**
1. Dashboard Next.js para visualizar conversas do WhatsApp
2. Leitura direta do Supabase (tabelas que n8n já preenche)
3. Envio de comandos via webhooks n8n (enviar mensagem manual, transferir para humano)
4. Realtime updates via Supabase Realtime
5. Métricas básicas (total conversas, status, etc.)

### Restrições Técnicas

**Princípios da Phase 2:**
- Dashboard é **read-only** (exceto comandos via webhook)
- n8n continua como motor de processamento
- Não modificar workflow n8n existente
- Multi-tenant architecture com `client_id`

**Stack Técnico:**
- Next.js 14 (App Router)
- TypeScript
- Tailwind CSS + shadcn/ui
- Supabase (leitura + realtime)
- Vercel (deploy)

### Tabelas do Supabase

**Tabelas conhecidas (n8n usa):**
- `Clientes WhatsApp` - registros de clientes
- `n8n_chat_histories` - histórico de conversas
- `documents` - vector store RAG

**Tabelas planejadas (podem não existir):**
- `clients` - configuração multi-tenant
- `conversations` - estado das conversas
- `messages` - mensagens individuais
- `usage_logs` - tracking de custos

⚠️ **IMPORTANTE**: Etapa 0 valida schema real antes de implementar queries.

### Variáveis de Ambiente Necessárias

```env
# Supabase (leitura de conversas)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# n8n Webhooks (comandos do dashboard)
N8N_WEBHOOK_BASE_URL=https://your-n8n-instance.com
N8N_SEND_MESSAGE_WEBHOOK=/webhook/send-message
N8N_TRANSFER_HUMAN_WEBHOOK=/webhook/transfer-human

# Next Auth (opcional - Phase 2 pode ser sem auth)
# NEXTAUTH_URL=http://localhost:3000
# NEXTAUTH_SECRET=your-secret
```

### Referências "asimov" a Substituir

**3 ocorrências em arquivos markdown:**
1. `CLAUDE.md:103` - `asimovFlow.ts` → `chatbotFlow.ts`
2. `plano_de_arquitetura_*.md:94` - `asimovFlow(req, config)` → `chatBotFlow(req, config)`
3. `plano_de_arquitetura_*.md:187` - `asimovFlow.ts` → `chatBotFlow.ts`

---

## Plano de Implementação

### Arquivos a Criar

**Estrutura completa do projeto:**
```
C:\Users\Luisf\OneDrive\Github\Chatbot v2\
├── .env.local (gitignored)
├── .env.example
├── .gitignore
├── package.json
├── tsconfig.json
├── next.config.js
├── tailwind.config.ts
├── postcss.config.js
├── components.json (shadcn config)
└── src/
    ├── app/
    │   ├── layout.tsx
    │   ├── page.tsx
    │   ├── globals.css
    │   ├── dashboard/
    │   │   ├── layout.tsx
    │   │   ├── page.tsx
    │   │   └── conversations/
    │   │       └── [phone]/page.tsx
    │   └── api/
    │       ├── conversations/route.ts
    │       ├── messages/[phone]/route.ts
    │       └── commands/
    │           ├── send-message/route.ts
    │           └── transfer-human/route.ts
    ├── components/
    │   ├── ui/ (shadcn components)
    │   │   ├── button.tsx
    │   │   ├── card.tsx
    │   │   ├── badge.tsx
    │   │   ├── input.tsx
    │   │   ├── textarea.tsx
    │   │   ├── toast.tsx
    │   │   ├── scroll-area.tsx
    │   │   └── separator.tsx
    │   ├── ConversationList.tsx
    │   ├── ConversationDetail.tsx
    │   ├── MessageBubble.tsx
    │   ├── SendMessageForm.tsx
    │   └── MetricsDashboard.tsx
    ├── lib/
    │   ├── supabase.ts
    │   ├── types.ts
    │   └── utils.ts
    └── hooks/
        ├── useConversations.ts
        ├── useMessages.ts
        └── useRealtimeMessages.ts
```

### Arquivos a Modificar

1. **`CLAUDE.md`** - Substituir "asimov" por "chatbot" (linha 103)
2. **`plano_de_arquitetura_saa_s_whats_app_resumao_n_8_n_→_next.md`** - Substituir "asimov" por "chatbot" (linhas 94, 187)

---

## Ordem de Implementação

### Etapa 0: Validação do Schema Supabase (CRÍTICO - PRIMEIRO)

**Por que primeiro**: Precisamos saber estrutura real das tabelas antes de criar queries

**Tarefas:**
1. Conectar ao Supabase e inspecionar schema real
2. Documentar estrutura de `Clientes WhatsApp`, `n8n_chat_histories`, `documents`
3. Verificar se existem `client_id` nas tabelas (multi-tenant) ou se é single-tenant
4. Identificar campos de status de conversa
5. Criar `src/lib/types.ts` baseado no schema real

### Etapa 1: Inicialização do Next.js

**Por que agora**: Estrutura base necessária para tudo

**Tarefas:**
1. Executar `npx create-next-app@latest` com:
   - TypeScript: Yes
   - ESLint: Yes
   - Tailwind CSS: Yes
   - App Router: Yes
2. Instalar dependências:
   ```bash
   npm install @supabase/supabase-js @supabase/ssr
   npm install -D @types/node
   npx shadcn-ui@latest init
   ```
3. Configurar `next.config.js` (image domains para Supabase)
4. Criar `.env.example` documentado
5. Criar `.env.local` com valores reais (usuário preenche)

### Etapa 2: Setup Supabase Client

**Por que agora**: Todas as páginas/APIs dependem do cliente Supabase

**Tarefas:**
1. Criar `src/lib/supabase.ts`:
   - Server client (service role key)
   - Browser client (anon key)
   - Type helpers
2. Criar `src/lib/types.ts`:
   - Interfaces baseadas no schema validado (Etapa 0)
   - `Customer`, `Message`, `Conversation`
   - Enum `ConversationStatus`
3. Criar `src/lib/utils.ts`:
   - Helper `cn()` para classNames
   - Formatters (phone, date/time)
   - Cost calculation helpers

### Etapa 3: Componentes UI Base (shadcn)

**Por que agora**: Dashboard precisa de componentes visuais

**Tarefas:**
1. Instalar componentes shadcn:
   ```bash
   npx shadcn-ui@latest add button card badge input textarea toast scroll-area separator
   ```
2. Customizar `src/app/globals.css` com cores do tema

### Etapa 4: API Routes (Backend)

**Por que antes das páginas**: Páginas consomem essas APIs

**Tarefas:**
1. **`src/app/api/conversations/route.ts`**:
   - GET: Lista conversas com query params (status, limit, offset)
   - Join para última mensagem
   - Ordenar por last_update DESC
2. **`src/app/api/messages/[phone]/route.ts`**:
   - GET: Histórico de mensagens de um número
   - Busca em `n8n_chat_histories`
   - Ordenar cronologicamente
3. **`src/app/api/commands/send-message/route.ts`**:
   - POST: Proxy para webhook n8n
   - Validar body antes de enviar
4. **`src/app/api/commands/transfer-human/route.ts`**:
   - POST: Proxy para webhook n8n
   - Trigger transferência humana

### Etapa 5: Hooks Customizados

**Por que agora**: Componentes usam esses hooks

**Tarefas:**
1. **`src/hooks/useConversations.ts`**:
   - Fetch lista via API
   - Cache/revalidação
2. **`src/hooks/useMessages.ts`**:
   - Fetch mensagens de um phone
   - Paginação se necessário
3. **`src/hooks/useRealtimeMessages.ts`**:
   - Supabase Realtime subscription
   - Escuta mudanças em `n8n_chat_histories`
   - Atualiza UI automaticamente

### Etapa 6: Componentes de Dashboard

**Por que agora**: Temos API + hooks prontos

**Tarefas:**
1. **`src/components/MessageBubble.tsx`**:
   - Visual de mensagem (incoming/outgoing)
   - Suporte para tipos (text, audio, image)
2. **`src/components/ConversationList.tsx`**:
   - Lista com preview da última mensagem
   - Badge de status
   - Click navega para detalhe
3. **`src/components/ConversationDetail.tsx`**:
   - Área de mensagens com scroll
   - Usa `useRealtimeMessages()`
   - Botão "Transferir para Humano"
4. **`src/components/SendMessageForm.tsx`**:
   - Input + botão enviar
   - Chama API send-message
   - Toast de feedback
5. **`src/components/MetricsDashboard.tsx`**:
   - Cards com métricas básicas
   - Total conversas, aguardando humano, mensagens hoje

### Etapa 7: Páginas do Dashboard

**Por que por último**: Orquestra todos os componentes

**Tarefas:**
1. **`src/app/layout.tsx`**:
   - Layout raiz com metadata
   - Provider do Toaster
2. **`src/app/page.tsx`**:
   - Landing page ou redirect para /dashboard
3. **`src/app/dashboard/layout.tsx`**:
   - Sidebar com navegação
   - Header "ChatBot Dashboard"
4. **`src/app/dashboard/page.tsx`**:
   - Renderiza MetricsDashboard + ConversationList
5. **`src/app/dashboard/conversations/[phone]/page.tsx`**:
   - Renderiza ConversationDetail + SendMessageForm

### Etapa 8: Correção de Nomenclatura

**Por que agora**: Limpeza final

**Tarefas:**
1. Substituir "asimov" por "chatbot" nos 3 arquivos markdown identificados
2. Verificar se não há outras referências

### Etapa 9: Testes Locais

**Por que por último**: Validar tudo funcionando

**Tarefas:**
1. `npm run dev` e acessar `http://localhost:3000`
2. Verificar conexão Supabase (dados carregam?)
3. Testar Realtime (enviar mensagem via WhatsApp, ver aparecer?)
4. Testar comandos manuais
5. Verificar responsividade
6. Conferir console de erros

---

## Riscos Técnicos

### 1. Schema Real Difere do Planejado
**Risco**: Tabelas planejadas (`clients`, `conversations`, `messages`) podem não existir

**Mitigação**:
- Etapa 0 valida schema ANTES de codificar
- Adaptar queries para tabelas existentes (`Clientes WhatsApp`, `n8n_chat_histories`)
- Derivar status de conversa de campos existentes

### 2. Formato de `n8n_chat_histories` Desconhecido
**Risco**: Mensagens podem estar em JSON blob vs colunas estruturadas

**Mitigação**:
- Inspecionar registros reais na Etapa 0
- Criar parser em `src/lib/utils.ts` se necessário

### 3. Webhooks n8n Não Existem Ainda
**Risco**: Workflow n8n atual não tem webhooks HTTP para comandos

**Mitigação**:
- Começar Phase 2 apenas read-only (sem comandos)
- Adicionar webhooks no n8n posteriormente
- API routes retornam "Not implemented" temporariamente

### 4. Supabase Realtime Limits
**Risco**: Muitas conversas simultâneas podem exceder limites

**Mitigação**:
- Começar com polling (refetch a cada X segundos)
- Adicionar Realtime apenas na página de detalhe
- Filtrar Realtime por phone específico

### 5. Multi-Tenant vs Single-Tenant
**Risco**: Sistema atual pode ser single-tenant apesar de documentação mencionar multi-tenant

**Mitigação**:
- Etapa 0 valida presença de `client_id`
- Se single-tenant, remover lógica de client_id
- Hardcode client para Phase 2

---

## Próximo Passo

Para implementar este plano, digite: **ok**, **continue**, ou **approve**

Para cancelar, digite: **cancel** ou inicie uma nova tarefa
