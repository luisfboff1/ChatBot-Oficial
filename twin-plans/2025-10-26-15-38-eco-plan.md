# Twin Development Plan (Econ√¥mico)
Generated: 2025-10-26
Task: Implementar Fase 3 - Migrar l√≥gica n8n para Next.js TypeScript
Quality Level: pragmatic

## An√°lise R√°pida

**Estado Atual:** Projeto Next.js com dashboard funcional (Fase 2), Supabase configurado. Workflow n8n (IA.json - 1783 linhas) processa: webhook ‚Üí filtro ‚Üí parsing ‚Üí check cliente ‚Üí media (√°udio/imagem) ‚Üí Redis batching ‚Üí AI (Groq Llama + RAG + memory) ‚Üí formata√ß√£o ‚Üí envio WhatsApp ‚Üí handoff humano.

**O que precisa mudar:** Criar estrutura modular TypeScript com src/nodes/ (15+ nodes at√¥micos), src/flows/chatbotFlow.ts (orquestra√ß√£o), src/lib/ com clientes (redis, openai, groq, meta, gmail), configurar vari√°veis de ambiente adicionais.

## Plano de Implementa√ß√£o

### Estrutura de Diret√≥rios a Criar:
```
src/
  nodes/        # Fun√ß√µes at√¥micas reutiliz√°veis
  flows/        # Orquestra√ß√£o do chatbot
  lib/          # Clientes de servi√ßos externos (adicionar novos)
```

### Arquivos a Criar:

#### Nodes (src/nodes/):
- `filterStatusUpdates.ts` - Filtra mensagens de status do WhatsApp
- `parseMessage.ts` - Extrai nome, telefone, tipo de mensagem, conte√∫do
- `checkOrCreateCustomer.ts` - Verifica/cria registro em Clientes WhatsApp
- `downloadMetaMedia.ts` - Baixa √°udio/imagem da Meta API
- `transcribeAudio.ts` - Transcreve √°udio com OpenAI Whisper
- `analyzeImage.ts` - Analisa imagem com GPT-4o Vision
- `normalizeMessage.ts` - Unifica mensagem texto/√°udio/imagem
- `pushToRedis.ts` - Adiciona mensagem √† lista Redis (batching)
- `batchMessages.ts` - Aguarda 10s e consolida mensagens do Redis
- `generateAIResponse.ts` - Processa com Groq AI Agent (main agent + tools)
- `formatResponse.ts` - Divide resposta AI em mensagens WhatsApp
- `sendWhatsAppMessage.ts` - Envia mensagem via Meta API
- `handleHumanHandoff.ts` - Atualiza status, busca hist√≥rico, resume, envia email
- `getRAGContext.ts` - Busca documentos relevantes do vector store Supabase
- `getChatHistory.ts` - Recupera √∫ltimas 15 mensagens do PostgreSQL

#### Flows (src/flows/):
- `chatbotFlow.ts` - Orquestra todos os nodes na ordem correta

#### Lib (src/lib/):
- `redis.ts` - Cliente Redis (Upstash ou node-redis)
- `openai.ts` - Cliente OpenAI (whisper, gpt-4o, embeddings)
- `groq.ts` - Cliente Groq (Llama 3.3 70B)
- `meta.ts` - Cliente Meta WhatsApp Business API
- `gmail.ts` - Cliente Gmail (nodemailer)
- `clients.ts` - getClientConfig() pattern (futuro multi-tenant)
- `types.ts` - Interfaces TypeScript (WhatsAppWebhookPayload, ParsedMessage, etc.)

#### Environment (.env.local):
Adicionar vari√°veis:
```env
# Redis (batching)
REDIS_URL=

# OpenAI (whisper, gpt-4o, embeddings)
OPENAI_API_KEY=

# Groq (main LLM)
GROQ_API_KEY=

# Meta WhatsApp Business API
META_ACCESS_TOKEN=
META_PHONE_NUMBER_ID=899639703222013

# Gmail (handoff notifications)
GMAIL_USER=
GMAIL_PASSWORD=
```

#### Dependencies (package.json):
```bash
npm install redis openai groq-sdk axios nodemailer
npm install -D @types/nodemailer
```

### Passos:

1. **Criar estrutura de diret√≥rios**
   - Criar src/nodes/ e src/flows/
   - src/lib/ j√° existe

2. **Instalar depend√™ncias NPM**
   - redis, openai, groq-sdk, axios, nodemailer

3. **Implementar clientes b√°sicos (src/lib/)**
   - redis.ts, openai.ts, groq.ts, meta.ts, gmail.ts, types.ts

4. **Implementar nodes at√¥micos (src/nodes/)**
   - Ordem: parsing ‚Üí supabase ‚Üí media ‚Üí redis ‚Üí AI ‚Üí output

5. **Implementar fluxo principal (src/flows/chatbotFlow.ts)**
   - Orquestra nodes, gerencia switches, tratamento de erros

6. **Atualizar .env.local**
   - Adicionar todas as vari√°veis necess√°rias

### ‚ö†Ô∏è Riscos:

- **Credenciais expostas no IA.json** - Meta Access Token hardcoded (migrar para env)
- **Redis memory leak** - Garantir delete de keys ap√≥s batching
- **Race condition** - Batching simult√¢neo pode duplicar, usar Redis LPUSH consistente
- **WhatsApp 24h window** - Validar timestamp antes de envio
- **OpenAI rate limits** - Implementar retry com exponential backoff
- **Concurrency serverless** - Futuro: usar Redis locks ou queues quando migrar webhook

### üí° Notas Importantes:

- **N√£o migrar webhook agora** - Apenas preparar nodes/flows
- **Sistema multi-agent** - Main Agent + Sub-agent Tool + RAG + Human Handoff Tool
- **Memory PostgreSQL** - 15 mensagens contexto, session_id = telefone
- **Message formatter** - Dividir em `\n\n` para UX WhatsApp
- **Prompts em portugu√™s** - Copiar exatamente do JSON

## Pr√≥ximo Passo
Digite: **ok**, **continue**, ou **approve**
